<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Similaridade e Valida√ß√£o</title>
    <style>
        body { font-family: 'Segoe UI', Roboto, sans-serif; background: #f0f2f5; padding: 20px; color: #333; }
        .container { max-width: 1400px; margin: 0 auto; background: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        
        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin-bottom: 30px; }
        .stat-card { background: #f9fbe7; border: 1px solid #c5e1a5; padding: 10px; border-radius: 6px; text-align: center; }
        .stat-val { font-size: 1.1em; font-weight: bold; color: #33691e; margin-bottom: 4px; }
        .stat-lbl { font-size: 0.75em; color: #558b2f; text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-card.main { background: #e8f5e9; border-color: #a5d6a7; transform: scale(1.05); z-index: 2; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        /* Table Styles */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.9em; }
        th { background: #37474f; color: white; padding: 12px 8px; text-align: left; vertical-align: middle;}
        td { padding: 8px; border-bottom: 1px solid #eee; vertical-align: middle; }
        tr:hover { background-color: #f1f8e9; }
        
        /* Tags */
        .tag-match { background: #c8e6c9; color: #1b5e20; border: 1px solid #a5d6a7; padding: 1px 5px; border-radius: 4px; font-size: 0.8em; margin: 1px; display: inline-block; }
        .tag-miss { background: #ffebee; color: #c62828; padding: 1px 5px; border-radius: 4px; font-size: 0.8em; margin: 1px; display: inline-block; opacity: 0.7; }
        
        /* Checkbox Customizado */
        .check-wrapper { display: flex; align-items: center; justify-content: center; }
        .chk-concurso { width: 18px; height: 18px; cursor: pointer; accent-color: #2e7d32; }
        
        /* Barra flutuante de a√ß√£o */
        .floating-action {
            position: fixed; bottom: 30px; right: 30px;
            background: #fff; padding: 15px 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.25);
            border-radius: 50px; border: 2px solid #2e7d32;
            display: none; align-items: center; gap: 15px; z-index: 999;
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp { from { transform: translateY(100px); } to { transform: translateY(0); } }
        
        .btn-lote {
            background: #2e7d32; color: white; border: none;
            padding: 10px 25px; border-radius: 25px;
            font-weight: bold; cursor: pointer; font-size: 0.9em;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: background 0.2s;
        }
        .btn-lote:hover { background: #1b5e20; }

        /* Modal & Form */
        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:1000; backdrop-filter: blur(2px); }
        .modal-content { background: white; margin: 50px auto; width: 90%; max-width: 1000px; border-radius: 10px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); overflow: hidden; display: flex; flex-direction: column; max-height: 90vh; }
        .modal-body { padding: 20px; overflow-y: auto; flex-grow: 1; }
        .modal-header { background: #2e7d32; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        
        /* Formulario Style */
        .config-form { background:#e8f5e9; padding:15px; border-radius:8px; border: 1px solid #c8e6c9; display: flex; flex-wrap: wrap; gap: 15px; align-items: center; justify-content: center; }
        .config-group { background:white; padding:5px 10px; border-radius:5px; border:1px solid #a5d6a7; text-align:center; }
        .config-lbl { font-size:0.7em; font-weight:bold; color:#555; display: block; margin-bottom: 3px; }
        .inp-sm { width:45px; text-align: center; border: 1px solid #ccc; border-radius: 3px; }
        .btn-action { background:#2e7d32; color:white; border:none; padding:0 25px; height:45px; border-radius:4px; cursor:pointer; font-weight:bold; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .btn-action:hover { background:#1b5e20; }
        .btn-simular-list { background: #1976d2; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size:0.85em; }
    </style>
    <script>
        let concursoSelecionadoId = null;

        // --- L√ìGICA DE CHECKBOX ---
        function toggleSelection() {
            const checkboxes = document.querySelectorAll('.chk-concurso:checked');
            const floatBar = document.getElementById('floatingBar');
            const countSpan = document.getElementById('countSel');
            
            if (checkboxes.length > 0) {
                floatBar.style.display = 'flex';
                countSpan.innerText = checkboxes.length;
            } else {
                floatBar.style.display = 'none';
            }
        }

        // --- MODO √öNICO ---
        function abrirConfiguracao(id) {
            concursoSelecionadoId = id;
            document.getElementById('modalConfig').style.display = 'block';
            document.getElementById('displayConcId').innerText = id;
            document.getElementById('resultadosContainer').innerHTML = ''; 
            document.getElementById('formConfig').style.display = 'flex'; 
            
            // Reseta para envio normal (√∫nico)
            const form = document.getElementById('formSimulacao');
            form.onsubmit = rodarSimulacaoUnica;
        }

        function rodarSimulacaoUnica(event) {
            event.preventDefault();
            if(!concursoSelecionadoId) return;

            const f = document.getElementById('formSimulacao');
            const params = new URLSearchParams(new FormData(f));
            params.append('cid', concursoSelecionadoId);

            iniciarProcessamentoUI();

            fetch(`/simular-cenario?${params.toString()}`)
                .then(r => r.text())
                .then(html => {
                    document.getElementById('resultadosContainer').innerHTML = html;
                });
        }

        // --- MODO LOTE (BATCH) ---
        function abrirConfiguracaoLote() {
            document.getElementById('modalConfig').style.display = 'block';
            document.getElementById('displayConcId').innerText = "LOTE SELECIONADO";
            document.getElementById('resultadosContainer').innerHTML = '';
            document.getElementById('formConfig').style.display = 'flex';
            
            // Altera o comportamento do submit para Batch
            const form = document.getElementById('formSimulacao');
            form.onsubmit = rodarSimulacaoLote;
        }

        function rodarSimulacaoLote(event) {
            event.preventDefault();
            
            // Coleta IDs marcados
            const checkboxes = document.querySelectorAll('.chk-concurso:checked');
            const ids = Array.from(checkboxes).map(cb => parseInt(cb.value));
            
            // Coleta Form
            const f = document.getElementById('formSimulacao');
            const formData = new FormData(f);
            const params = Object.fromEntries(formData.entries());

            iniciarProcessamentoUI("üöÄ Processando Lote...", "Isso pode levar alguns minutos. Estamos gerando universos estat√≠sticos √∫nicos para cada cen√°rio.");

            fetch('/simular-lote', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ids: ids, params: params })
            })
            .then(r => r.text())
            .then(html => {
                document.getElementById('resultadosContainer').innerHTML = html;
            });
        }

        function iniciarProcessamentoUI(titulo="üöÄ Executando Motor V5...", msg="Processando estat√≠sticas da √©poca, gerando jogos e validando...") {
            document.getElementById('formConfig').style.display = 'none';
            document.getElementById('resultadosContainer').innerHTML = `<div style="text-align:center; padding:50px;"><h2 style="color:#2e7d32">${titulo}</h2><p>${msg}</p></div>`;
        }
    </script>
</head>
<body>
    {% include 'navbar.html' %}

    <div class="container">
        <div style="margin-bottom:20px; border-bottom:1px solid #eee; padding-bottom:10px;">
            <h2 style="color:#2e7d32; margin:0;">üß¨ Similaridade Gen√©tica (Concurso {{ alvo.concurso }})</h2>
            <p style="margin:5px 0 0 0; color:#666; font-size:0.9em;">Perfil estat√≠stico do alvo. Selecione concursos passados para validar o modelo em lote.</p>
        </div>

        <!-- INDICADORES ALVO -->
        <div class="stats-grid">
            <div class="stat-card main"><div class="stat-val">{{ alvo.pares }}</div><div class="stat-lbl">Pares</div></div>
            <div class="stat-card main"><div class="stat-val">{{ alvo.faixa_soma }}</div><div class="stat-lbl">Soma</div></div>
            <div class="stat-card"><div class="stat-val" style="font-family:monospace">{{ alvo.quadrantes }}</div><div class="stat-lbl">Quadrantes</div></div>
            <div class="stat-card"><div class="stat-val">{{ alvo.faixa_deltas }}</div><div class="stat-lbl">Espalhamento</div></div>
            <div class="stat-card"><div class="stat-val">{{ alvo.repetidas }}</div><div class="stat-lbl">Repetidas</div></div>
            <div class="stat-card"><div class="stat-val">{{ alvo.linhas }}</div><div class="stat-lbl">Linhas</div></div>
            <div class="stat-card"><div class="stat-val">{{ alvo.colunas }}</div><div class="stat-lbl">Colunas</div></div>
            <div class="stat-card"><div class="stat-val">{{ alvo.primos }}</div><div class="stat-lbl">Primos</div></div>
            <div class="stat-card"><div class="stat-val">{{ alvo.mult3 }}</div><div class="stat-lbl">Mult 3</div></div>
            <div class="stat-card"><div class="stat-val">{{ alvo.faixa_t39 }}</div><div class="stat-lbl">Temp 39</div></div>
            <div class="stat-card"><div class="stat-val">{{ alvo.faixa_t21 }}</div><div class="stat-lbl">Temp 21</div></div>
        </div>

        <table>
            <thead>
                <tr>
                    <th width="50" style="text-align:center;">Select</th> <!-- Coluna 1 -->
                    <th width="80">Conc</th>                              <!-- Coluna 2 -->
                    <th width="120">Similaridade</th>                     <!-- Coluna 3 -->
                    <th>DNA (Indicadores Iguais)</th>                     <!-- Coluna 4 -->
                    <th>Diferen√ßas</th>                                   <!-- Coluna 5 -->
                    <th>Resultado Seguinte</th>                           <!-- Coluna 6 -->
                    <th width="100" style="text-align:center;">A√ß√£o</th>  <!-- Coluna 7 -->
                </tr>
            </thead>
            <tbody>
                {% for s in similares %}
                <tr>
                    <!-- C√âLULA 1: Checkbox -->
                    <td style="text-align:center;">
                        <div class="check-wrapper">
                            <input type="checkbox" class="chk-concurso" value="{{ s.concurso }}" onchange="toggleSelection()">
                        </div>
                    </td>
                    
                    <!-- C√âLULA 2: Concurso -->
                    <td style="font-weight:bold; font-size:1.1em; color:#37474f;">{{ s.concurso }}</td>
                    
                    <!-- C√âLULA 3: Similaridade -->
                    <td>
                        <strong style="color:{{ '#2e7d32' if s.similaridade > 80 else '#f9a825' }}">{{ s.similaridade }}%</strong>
                    </td>
                    
                    <!-- C√âLULA 4: Matches -->
                    <td>
                        {% for m in s.matches %}
                        <span class="tag-match">{{ m }}</span>
                        {% endfor %}
                    </td>
                    
                    <!-- C√âLULA 5: Misses -->
                    <td>
                         {% if 'Pares' not in s.matches %}<span class="tag-miss">P: {{ s.assinatura.pares }}</span>{% endif %}
                         {% if 'Soma' not in s.matches %}<span class="tag-miss">S: {{ s.assinatura.faixa_soma }}</span>{% endif %}
                         {% if 'Primos' not in s.matches %}<span class="tag-miss">Pr: {{ s.assinatura.primos }}</span>{% endif %}
                         {% if 'Mult 3' not in s.matches %}<span class="tag-miss">M3: {{ s.assinatura.mult3 }}</span>{% endif %}
                         {% if 'Repetidas' not in s.matches %}<span class="tag-miss">R: {{ s.assinatura.repetidas }}</span>{% endif %}
                    </td>
                    
                    <!-- C√âLULA 6: Resultado Futuro -->
                    <td>
                        <div style="font-size:0.75em; color:#888;">Conc {{ s.concurso_futuro }}</div>
                        <div style="font-weight:bold; color:#0277bd; font-size:0.9em;">{{ s.res_futuro }}</div>
                    </td>
                    
                    <!-- C√âLULA 7: Bot√£o Validar -->
                    <td style="text-align:center;">
                        <button class="btn-simular-list" onclick="abrirConfiguracao({{ s.concurso }})">Validar</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- BARRA FLUTUANTE DE LOTE -->
    <div id="floatingBar" class="floating-action">
        <div>
            <span style="font-weight:bold; font-size:1.1em; color:#2e7d32;" id="countSel">0</span> cen√°rios selecionados
        </div>
        <button class="btn-lote" onclick="abrirConfiguracaoLote()">PROCESSAR LOTE</button>
    </div>

    <!-- MODAL CONFIG -->
    <div id="modalConfig" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span>Configurar Simula√ß√£o: <strong><span id="displayConcId"></span></strong></span>
                <span onclick="document.getElementById('modalConfig').style.display='none'" style="cursor:pointer; font-size:1.5em;">&times;</span>
            </div>
            <div class="modal-body">
                
                <!-- FORMUL√ÅRIO -->
                <div id="formConfig" class="config-form">
                    <form id="formSimulacao" style="display:contents;">
                        
                        <!-- NOVO SELETOR DE MODELO -->
                        <div style="text-align:center; background:white; padding:5px; border-radius:5px; border:1px solid #a5d6a7;">
                            <label class="config-lbl" style="color:#1b5e20;">Modelo</label>
                            <select name="modelo" style="padding:4px; border:1px solid #ccc; border-radius:4px; font-weight:bold; color:#333;">
                                <option value="F4" selected>F4 - Quadra</option>
                                <option value="F5">F5 - Quina</option>
                            </select>
                        </div>

                        <div style="text-align:center;">
                            <label class="config-lbl">Qtd Jogos</label>
                            <input type="number" name="qtd" value="100" style="width:60px; padding:5px; text-align:center; border:1px solid #ccc; border-radius:4px; font-weight:bold;">
                        </div>
                        
                        <div class="config-group">
                            <label class="config-lbl">Meta 1</label>
                            Scr:<input type="number" name="s1" value="12" class="inp-sm"> Vol:<input type="number" name="p1" value="20" class="inp-sm">%
                        </div>
                        <div class="config-group">
                            <label class="config-lbl">Meta 2</label>
                            Scr:<input type="number" name="s2" value="11" class="inp-sm"> Vol:<input type="number" name="p2" value="30" class="inp-sm">%
                        </div>
                        <div class="config-group">
                            <label class="config-lbl">Meta 3</label>
                            Scr:<input type="number" name="s3" value="10" class="inp-sm"> Vol:<input type="number" name="p3" value="30" class="inp-sm">%
                        </div>
                        <div class="config-group">
                            <label class="config-lbl">Meta 4</label>
                            Scr:<input type="number" name="s4" value="9" class="inp-sm"> Vol:<input type="number" name="p4" value="20" class="inp-sm">%
                        </div>
                        
                        <div style="text-align:center;">
                            <label class="config-lbl" style="color:#d32f2f;">Press√£o %</label>
                            <input type="number" name="pressao" value="60" style="width:60px; padding:5px; text-align:center; border:1px solid #ccc; border-radius:4px;">
                        </div>
                        
                        <button type="submit" class="btn-action">PROCESSAR</button>
                    </form>
                </div>

                <!-- √ÅREA DE RESULTADOS -->
                <div id="resultadosContainer" style="margin-top:20px;"></div>
            </div>
        </div>
    </div>
</body>
</html>